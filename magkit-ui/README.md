# magkit-ui Module

## Overview
`magkit-ui` adds UI-centric extensions and developer aids for Magnolia CMS authoring and rendering. It focuses on:

### Main Features
- Rendering Diagnostics:
  - `RenderingMetrics`: Lightweight rendering listener measuring per-definition (component, area, page) wall-clock time and logging structured DEBUG lines.
  - `OnlyOnceCopyGenerator`: Guarded auto-generation ensuring template/area children are created only once (sets `isAutogenerated` marker).
- Authoring Field Enhancements:
  - `ExtendedTextFieldDefinition`: Text field with an optional recommended length indicator for editors.
  - Extended link components (`ExtendedLinkBinder`, `ExtendedLinkConverter`, `LinkConverter`) for robust link normalization and binding.
- Validation Suite:
  - `UniqueValueValidatorDefinition`: Ensures property uniqueness (e.g. title) across nodes in a workspace.
  - `NodeTypeValidatorDefinition`, `TemplateIdValidatorDefinition`, `TemplateTypeValidatorDefinition`: Restrict values to allowed node/template characteristics.
  - `MimeTypeValidatorDefinition`: Validates file MIME types.
  - `StringValuesValidatorDefinition`: Constrains free-text to accepted value sets.
- Export & Download:
  - `TableAsExcelResourceProvider`: Converts a Vaadin Table (legacy v7) into a downloadable Excel file with headers, hyperlinks, and auto-sized columns.
- Internationalization:
  - `UiTranslator`: Utility for translating keys within UI contexts.
- Auxiliary UI / Model Components:
  - `ComparableStatusLabel`, `ComparableLink`: Comparable wrappers for consistent sorting of status/link UI elements.
  - `FolderModel`: Simplified folder representation for template logic.
  - `RedirectionExceptionMapper`: Maps internal redirection exceptions to appropriate responses.

These utilities reduce repetitive boilerplate, enhance editorial guidance, and provide operational transparency during rendering.

## Usage
Add the dependency via the parent POM or directly.

### Option 1: Parent (recommended when using multiple magkit modules)
```xml
<parent>
  <groupId>de.ibmix.magkit</groupId>
  <artifactId>magkit</artifactId>
  <version>1.1.0</version><!-- use a released version -->
</parent>

<dependencies>
  <dependency>
    <groupId>de.ibmix.magkit</groupId>
    <artifactId>magkit-ui</artifactId>
    <version>${project.version}</version>
  </dependency>
</dependencies>
```

### Option 2: Direct dependency
```xml
<dependency>
  <groupId>de.ibmix.magkit</groupId>
  <artifactId>magkit-ui</artifactId>
  <version>1.1.0</version><!-- prefer released version for production -->
</dependency>
```

### Magnolia Compatibility
Designed for Magnolia 6.x. Requires Magnolia UI framework compatibility artifacts and (optionally) DAM & SPA rendering modules (see this module's POM for details).

## Examples
Short examples illustrating main features.

### 1. Register Rendering Metrics Listener
Configure in YAML (JCR config equivalent) and enable DEBUG logging:
```yaml
/server/rendering/engine/listeners/renderingMetrics:
  class: de.ibmix.magkit.ui.rendering.RenderingMetrics
```
Log4j configuration example:
```properties
log4j.logger.de.ibmix.magkit.ui.rendering.RenderingMetrics=DEBUG
```
Resulting log line example:
```
Took  37ms for [myModule:component] at [/path/to/component].
```

### 2. Use OnlyOnceCopyGenerator for Auto-Generation
```java
Node area = /* obtain writable area node */;
AutoGenerationConfiguration<?> cfg = /* your Magnolia configuration */;
new OnlyOnceCopyGenerator(area).generate(cfg); // subsequent calls skip once flagged
```

### 3. Extended Text Field With Recommended Length
YAML field definition (dialog configuration):
```yaml
fields:
  teaser:
    class: de.ibmix.magkit.ui.dialogs.fields.ExtendedTextFieldDefinition
    name: teaser
    label: Teaser
    recommendedLength: 160
```
Editors see remaining characters indicator (not enforced hard limit unless `maxLength` is set).

### 4. Unique Value Validator Configuration
```yaml
fields:
  identifier:
    class: info.magnolia.ui.field.TextFieldDefinition
    name: identifier
    validators:
      uniqueId:
        class: de.ibmix.magkit.ui.dialogs.validators.UniqueValueValidatorDefinition
        propertyName: identifier
        nodeType: mgnl:page
        workspace: website
        errorMessage: Identifier must be unique.
```

### 5. Export a Vaadin Table to Excel
```java
Table table = buildTableWithData();
TableAsExcelResourceProvider provider = new TableAsExcelResourceProvider(table, "Content Export", "Project Content Export");
Link downloadLink = new Link("Download Excel", provider.getResource());
```
User clicks link to download an `.xlsx` file with visible columns, styled header, hyperlink cells.

### 6. Configure MIME Type Validator
```yaml
fields:
  asset:
    class: info.magnolia.ui.field.LinkFieldDefinition
    validators:
      mime:
        class: de.ibmix.magkit.ui.dialogs.validators.MimeTypeValidatorDefinition
        allowedTypes: [image/jpeg, image/png, application/pdf]
        errorMessage: Unsupported file type.
```

### 7. Translate UI Label Programmatically
```java
UiTranslator translator = /* obtain via DI or Components */;
String label = translator.translate("myModule.labels.title", Locale.ENGLISH);
```

### 8. Auto-Approve Link Normalization
```java
ExtendedLinkConverter converter = new ExtendedLinkConverter();
String normalized = converter.convertToModel("https://example.com/page?utm=test");
```

## License
Apache License 2.0. See root `LICENSE` or: http://www.apache.org/licenses/LICENSE-2.0

Distributed on an "AS IS" basis without warranties or conditions.

## Authors
- Frank Sommer (frank.sommer@ibmix.de)
- Wolf Bubenik (wolf.bubenik@ibmix.de)

Additional contributors acknowledged in source headers. Contributions welcome via pull requests and issues.

